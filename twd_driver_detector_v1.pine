//@version=5
indicator("TWD Triple-Layer + Driver Detector (Emoji HUD)", overlay=true)

// === ä½¿ç”¨è€…è¼¸å…¥ï¼ˆè«‹ä¾ä½ å¯¦éš›ä»£ç¢¼èª¿æ•´ï¼‰ ===
twdSym     = input.symbol("FX_IDC:USDTWD", "TWD FX (USD/TWD)")
tsmcSym    = input.symbol("TWSE:2330", "TSMC 2330")
etf0050Sym = input.symbol("TWSE:0050", "0050 ETF")
dxySym     = input.symbol("TVC:DXY",     "DXY Index")
soxSym     = input.symbol("NASDAQ:SOXX", "SOXX (SOX proxy)")

corrLen   = input.int(60,  "Correlation length (bars)", minval=10)
normLen   = input.int(100, "Normalization length",       minval=20)
corrThres = input.float(0.4, "ä¸»å› åˆ¤å®šé–€æª» (|corr| >=)", minval=0.1, maxval=1.0, step=0.05)

// === å–å¾—å„å•†å“æ”¶ç›¤åƒ¹ ===
twd   = request.security(twdSym,     timeframe.period, close)
tsmc  = request.security(tsmcSym,    timeframe.period, close)
etf50 = request.security(etf0050Sym, timeframe.period, close)
dxy   = request.security(dxySym,     timeframe.period, close)
sox   = request.security(soxSym,     timeframe.period, close)

// === ç°¡å–®æ¨™æº–åŒ–ï¼šåƒ¹æ ¼ / æœ€è¿‘ normLen çš„å¹³å‡ ===
f_norm(src) =>
    basis = ta.sma(src, normLen)
    basis == 0.0 ? na : src / basis

twdN   = f_norm(twd)
tsmcN  = f_norm(tsmc)
etf50N = f_norm(etf50)
dxyN   = f_norm(dxy)
soxN   = f_norm(sox)

// === ä¸»åœ–ï¼šä¸‰å±¤çµæ§‹ ===
plot(twdN,   title="TWD (USD/TWD, normalized)",    color=color.red,    linewidth=3)
plot(tsmcN,  title="TSMC 2330 (normalized)",       color=color.blue,   linewidth=2)
plot(etf50N, title="0050 ETF (normalized)",        color=color.green,  linewidth=2)
plot(dxyN,   title="DXY (normalized)",             color=color.orange, linewidth=1)
plot(soxN,   title="SOXX (SOX proxy, normalized)", color=color.purple, linewidth=1)

// === ç›¸é—œä¿‚æ•¸è¨ˆç®— ===
corr_twd_dxy  = ta.correlation(twd, dxy,  corrLen)
corr_twd_sox  = ta.correlation(twd, sox,  corrLen)
corr_twd_tsmc = ta.correlation(twd, tsmc, corrLen)

absD = math.abs(corr_twd_dxy)
absS = math.abs(corr_twd_sox)
absE = math.abs(corr_twd_tsmc)
maxAbs = math.max(absD, math.max(absS, absE))

driverUSD = absD == maxAbs and absD >= corrThres
driverSOX = absS == maxAbs and absS >= corrThres
driverEQ  = absE == maxAbs and absE >= corrThres

driver = driverUSD ? 1 : driverSOX ? 2 : driverEQ ? 3 : 0

// ä¸»å› åç¨±èˆ‡ emoji
driverName  = driver == 1 ? "ç¾å…ƒ DXY" : driver == 2 ? "å…¨çƒç§‘æŠ€ SOXX" : driver == 3 ? "æœ¬åœ°è‚¡å¸‚ 2330" : "æ··åˆ / ç„¡æ˜é¡¯ä¸»å°"
driverEmoji = driver == 1 ? "ğŸŸ§"       : driver == 2 ? "ğŸŸª"            : driver == 3 ? "ğŸŸ¦"            : "â¬œï¸"

// èƒŒæ™¯é¡è‰²ç‹€æ…‹ç‡ˆ
bgColor =
     driver == 1 ? color.new(color.orange, 85) :
     driver == 2 ? color.new(color.purple, 85) :
     driver == 3 ? color.new(color.blue,   85) :
                   color.new(color.gray,   90)

bgcolor(bgColor)

// === å³ä¸Šè§’å›ºå®šè³‡è¨Š labelï¼ˆå–®è¡Œï¼Œç™¾åˆ†æ¯”é¡¯ç¤ºï¼‰ ===
var label infoLabel = na

if barstate.islast
    label.delete(infoLabel)
    percD = absD * 100.0
    percS = absS * 100.0
    percE = absE * 100.0
    txt = "ä¸»å›  " + driverEmoji + " " + driverName + " | DXY=" + str.tostring(percD, "#.0") + "% SOXX=" + str.tostring(percS, "#.0") + "% 2330=" + str.tostring(percE, "#.0") + "%"
    topVal = math.max(math.max(twdN, tsmcN), math.max(etf50N, math.max(dxyN, soxN)))
    yPos = topVal + 0.15
    infoLabel := label.new(bar_index, yPos, txt, xloc=xloc.bar_index, yloc=yloc.price, style=label.style_label_right, textcolor=color.white, color=color.new(color.black, 40))
